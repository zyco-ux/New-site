<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bare Zorynth</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Cloudinary Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        /* [SAME CSS - NO CHANGES NEEDED] */
        :root {
            --primary-blue: #1A237E;
            --dark-blue: #0D1B4C;
            --light-blue: #E8EAF6;
            --accent-gold: #C5A028;
            --success-green: #0D9D6B;
            --warning-orange: #FF9800;
            --danger-red: #D32F2F;
            --admin-purple: #673AB7;
            --text-dark: #121212;
            --text-gray: #3A3A3A;
            --text-light: #666666;
            --bg-light: #F5F7FA;
            --white: #FFFFFF;
            --border-color: #D1D5E3;
            --shadow-sm: 0 1px 4px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 3px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --border-radius: 10px;
            --border-radius-sm: 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.4;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 14px;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--admin-purple), #5e35b1);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }

        .login-container.hidden {
            display: none;
        }

        .login-box {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            animation: fadeIn 0.5s ease;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo i {
            font-size: 48px;
            color: var(--admin-purple);
            margin-bottom: 16px;
        }

        .login-logo h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
        }

        .login-logo p {
            color: var(--text-light);
            font-size: 14px;
            margin-top: 8px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .form-input {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--admin-purple);
            box-shadow: 0 0 0 2px rgba(103, 58, 183, 0.1);
        }

        .login-btn {
            background-color: var(--admin-purple);
            color: var(--white);
            border: none;
            padding: 14px;
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            background-color: #5e35b1;
            transform: translateY(-1px);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--danger-red);
            padding: 12px 16px;
            border-radius: var(--border-radius-sm);
            border-left: 4px solid var(--danger-red);
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .login-error.show {
            display: flex;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Admin Header */
        .admin-header {
            background: linear-gradient(135deg, var(--admin-purple), #5e35b1);
            color: var(--white);
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
        }

        .admin-logo i {
            font-size: 24px;
        }

        .admin-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .logout-btn {
            background-color: rgba(255, 255, 255, 0.15);
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }

        /* Admin Navigation */
        .admin-nav {
            background-color: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            position: sticky;
            top: 80px;
            z-index: 99;
            box-shadow: var(--shadow-sm);
        }

        .nav-tabs {
            display: flex;
            gap: 2px;
            overflow-x: auto;
            padding: 0;
        }

        .nav-tab {
            padding: 16px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-gray);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            color: var(--admin-purple);
            background-color: var(--light-blue);
        }

        .nav-tab.active {
            color: var(--admin-purple);
            border-bottom-color: var(--admin-purple);
            background-color: rgba(103, 58, 183, 0.05);
        }

        /* Main Content */
        .admin-main {
            padding: 32px;
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        .admin-main.show {
            display: block;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Section */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 16px;
        }

        .stat-icon.users { background-color: rgba(103, 58, 183, 0.1); color: var(--admin-purple); }
        .stat-icon.transactions { background-color: rgba(13, 157, 107, 0.1); color: var(--success-green); }
        .stat-icon.balance { background-color: rgba(26, 35, 126, 0.1); color: var(--primary-blue); }
        .stat-icon.active { background-color: rgba(255, 152, 0, 0.1); color: var(--warning-orange); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 13px;
        }

        .recent-activity {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-dark);
        }

        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background-color: var(--bg-light);
            border-color: var(--admin-purple);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--light-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--admin-purple);
            margin-right: 12px;
        }

        .activity-details {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Users Section */
        .users-section {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--admin-purple);
            box-shadow: 0 0 0 2px rgba(103, 58, 183, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .users-table th {
            background-color: var(--bg-light);
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .users-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .users-table tr:hover {
            background-color: rgba(103, 58, 183, 0.02);
        }

        .users-table tr:last-child td {
            border-bottom: none;
        }

        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--light-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--admin-purple);
            font-weight: 600;
            font-size: 14px;
        }

        .user-avatar-small img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-email {
            font-size: 12px;
            color: var(--text-light);
        }

        .user-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background-color: rgba(13, 157, 107, 0.1);
            color: var(--success-green);
        }

        .status-inactive {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--danger-red);
        }

        .status-suspended {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-orange);
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .role-admin {
            background-color: rgba(103, 58, 183, 0.1);
            color: var(--admin-purple);
        }

        .role-user {
            background-color: rgba(26, 35, 126, 0.1);
            color: var(--primary-blue);
        }

        .action-buttons {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: var(--border-radius-sm);
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn.edit {
            background-color: rgba(26, 35, 126, 0.1);
            color: var(--primary-blue);
            border: 1px solid rgba(26, 35, 126, 0.2);
        }

        .action-btn.edit:hover {
            background-color: rgba(26, 35, 126, 0.2);
        }

        .action-btn.delete {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--danger-red);
            border: 1px solid rgba(211, 47, 47, 0.2);
        }

        .action-btn.delete:hover {
            background-color: rgba(211, 47, 47, 0.2);
        }

        .action-btn.reset {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-orange);
            border: 1px solid rgba(255, 152, 0, 0.2);
        }

        .action-btn.reset:hover {
            background-color: rgba(255, 152, 0, 0.2);
        }

        .action-btn.password {
            background-color: rgba(103, 58, 183, 0.1);
            color: var(--admin-purple);
            border: 1px solid rgba(103, 58, 183, 0.2);
        }

        .action-btn.password:hover {
            background-color: rgba(103, 58, 183, 0.2);
        }

        /* Transactions Section */
        .filters-row {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-gray);
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 13px;
            min-width: 150px;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--admin-purple);
        }

        /* Transaction Status Toggle */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success-green);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .transaction-status-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .transaction-status-label.approved {
            color: var(--success-green);
        }

        .transaction-status-label.pending {
            color: var(--warning-orange);
        }

        /* Account Number Styles */
        .account-number {
            font-family: monospace;
            font-size: 13px;
            background-color: var(--bg-light);
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 32px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .modal-close:hover {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        .modal-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-dark);
            font-size: 13px;
        }

        .form-input, .form-select, .form-textarea {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--admin-purple);
            box-shadow: 0 0 0 2px rgba(103, 58, 183, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .balance-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            background-color: var(--bg-light);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }

        .pin-group {
            background-color: var(--bg-light);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }

        .pin-input-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }

        .pin-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
        }

        .pin-input:focus {
            outline: none;
            border-color: var(--admin-purple);
            box-shadow: 0 0 0 2px rgba(103, 58, 183, 0.1);
        }

        .profile-picture-section {
            text-align: center;
            padding: 20px;
            background-color: var(--bg-light);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }

        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--light-blue);
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--admin-purple);
            font-size: 36px;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-btn {
            background-color: var(--admin-purple);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background-color: #5e35b1;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 10px 24px;
            border-radius: var(--border-radius-sm);
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--admin-purple);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: #5e35b1;
        }

        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
        }

        .btn-danger {
            background-color: var(--danger-red);
            color: var(--white);
        }

        .btn-danger:hover {
            background-color: #c62828;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: var(--white);
            border-radius: var(--border-radius-sm);
            padding: 12px 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
            max-width: 360px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .toast-success {
            background-color: rgba(13, 157, 107, 0.08);
            color: var(--success-green);
        }

        .toast-error {
            background-color: rgba(211, 47, 47, 0.08);
            color: var(--danger-red);
        }

        .toast-warning {
            background-color: rgba(255, 152, 0, 0.08);
            color: var(--warning-orange);
        }

        .toast-info {
            background-color: rgba(103, 58, 183, 0.08);
            color: var(--admin-purple);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 14px;
        }

        .toast-message {
            font-size: 12px;
            color: var(--text-gray);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .toast-close:hover {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light-blue);
            border-top-color: var(--admin-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Password Requirements */
        .password-requirements {
            background-color: var(--bg-light);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            font-size: 12px;
        }

        .requirement-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            color: var(--text-light);
        }

        .requirement-item.valid {
            color: var(--success-green);
        }

        .requirement-item i {
            width: 16px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .balance-group {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .login-box {
                padding: 30px 20px;
            }
            
            .admin-header, .admin-nav {
                padding: 16px;
            }
            
            .admin-main {
                padding: 16px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .search-box {
                width: 100%;
            }
            
            .filters-row {
                flex-direction: column;
            }
            
            .filter-select, .filter-input {
                width: 100%;
            }
            
            .modal {
                padding: 20px;
            }
        }

        @media (max-width: 576px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-user-shield"></i>
                <h1>Admin Dashboard</h1>
                <p>Bare Zorynth Management System</p>
            </div>
            
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorMessage">Invalid credentials</span>
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="loginEmail">Email Address</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="admin@example.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="loginPassword">Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>
            
            <div style="margin-top: 20px; text-align: center; color: var(--text-light); font-size: 12px;">
                <p>Default Admin Credentials:</p>
                <p>Email: admin@gmail.com</p>
                <p>Password: adminpassword</p>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard (Hidden by default) -->
    <div id="adminDashboard" style="display: none;">
        <!-- Admin Header -->
        <header class="admin-header">
            <div class="admin-logo">
                <i class="fas fa-user-shield"></i>
                <span>Bare Zorynth - Admin Dashboard</span>
            </div>
            <div class="admin-actions">
                <div class="admin-user">
                    <div class="admin-avatar" id="adminAvatar">A</div>
                    <div>
                        <div id="adminName">Loading...</div>
                        <div style="font-size: 12px; opacity: 0.9;">Administrator</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Admin Navigation -->
        <nav class="admin-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="nav-tab" data-section="users">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="nav-tab" data-section="transactions">
                    <i class="fas fa-exchange-alt"></i> Transactions
                </button>
                <button class="nav-tab" data-section="balances">
                    <i class="fas fa-university"></i> Balances
                </button>
                <button class="nav-tab" data-section="pins">
                    <i class="fas fa-key"></i> PIN Management
                </button>
                <button class="nav-tab" data-section="create-user">
                    <i class="fas fa-user-plus"></i> Create User
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="admin-main" id="adminMain">
            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
            </div>

            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboardSection">
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon users">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon transactions">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="stat-value" id="totalTransactions">0</div>
                        <div class="stat-label">Transactions Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon balance">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-value" id="totalBalance">$0</div>
                        <div class="stat-label">Total Bank Balance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon active">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                </div>

                <div class="recent-activity">
                    <h3 class="section-title">Recent Activity</h3>
                    <div class="activity-list" id="activityList">
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="activity-details">
                                <div class="activity-title">Admin logged in successfully</div>
                                <div class="activity-time">Just now â€¢ Admin Dashboard</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div class="content-section" id="usersSection">
                <div class="users-section">
                    <div class="section-header">
                        <h3 class="section-title">User Management</h3>
                        <div class="search-box">
                            <input type="text" class="search-input" id="userSearch" placeholder="Search users by name or email...">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="users-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Account Number</th>
                                    <th>Transaction Status</th>
                                    <th>Status</th>
                                    <th>Role</th>
                                    <th>Accounts</th>
                                    <th>PIN</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transactions Section -->
            <div class="content-section" id="transactionsSection">
                <div class="users-section">
                    <div class="section-header">
                        <h3 class="section-title">Transaction Management</h3>
                        <button class="btn btn-primary" id="addTransactionBtn">
                            <i class="fas fa-plus"></i> Add Transaction
                        </button>
                    </div>
                    <div class="filters-row">
                        <div class="filter-group">
                            <label class="filter-label">Select User</label>
                            <select class="filter-select" id="transactionUserFilter">
                                <option value="">All Users</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Transaction Type</label>
                            <select class="filter-select" id="transactionTypeFilter">
                                <option value="">All Types</option>
                                <option value="credit">Credit</option>
                                <option value="debit">Debit</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Date From</label>
                            <input type="date" class="filter-input" id="dateFromFilter">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Date To</label>
                            <input type="date" class="filter-input" id="dateToFilter">
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="users-table" id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Bank</th>
                                    <th>Recipient</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <!-- Transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Balances Section -->
            <div class="content-section" id="balancesSection">
                <div class="users-section">
                    <div class="section-header">
                        <h3 class="section-title">Balance Management</h3>
                        <button class="btn btn-primary" id="updateAllBalancesBtn">
                            <i class="fas fa-sync-alt"></i> Update All
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="users-table" id="balancesTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Checking</th>
                                    <th>Savings</th>
                                    <th>Investment</th>
                                    <th>Total</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="balancesTableBody">
                                <!-- Balances will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PIN Management Section -->
            <div class="content-section" id="pinsSection">
                <div class="users-section">
                    <div class="section-header">
                        <h3 class="section-title">PIN Management</h3>
                        <div class="search-box">
                            <input type="text" class="search-input" id="pinSearch" placeholder="Search users...">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="users-table" id="pinsTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Account Number</th>
                                    <th>Current PIN</th>
                                    <th>PIN Status</th>
                                    <th>Last PIN Change</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pinsTableBody">
                                <!-- PINs will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Create User Section -->
            <div class="content-section" id="createUserSection">
                <div class="users-section">
                    <div class="section-header">
                        <h3 class="section-title">Create New User</h3>
                        <button class="btn btn-secondary" id="resetFormBtn">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                    <form id="createUserForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">First Name *</label>
                                <input type="text" class="form-input" id="createFirstName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name *</label>
                                <input type="text" class="form-input" id="createLastName" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Email Address *</label>
                                <input type="email" class="form-input" id="createEmail" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number *</label>
                                <input type="tel" class="form-input" id="createPhone" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Account Number *</label>
                                <input type="text" class="form-input" id="createAccountNumber" required placeholder="e.g., 4500 1234 5678 9012">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Transaction Approval</label>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="createTransactionApproval" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="transaction-status-label approved" id="createTransactionStatusLabel">
                                        <i class="fas fa-check-circle"></i> Approved
                                    </span>
                                </div>
                                <small style="color: var(--text-light); font-size: 12px;">
                                    When off, all user transactions will be marked as pending
                                </small>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Password *</label>
                                <input type="password" class="form-input" id="createPassword" required minlength="8">
                                <small style="color: var(--text-light); font-size: 12px;">Minimum 8 characters</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm Password *</label>
                                <input type="password" class="form-input" id="createConfirmPassword" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Role *</label>
                                <select class="form-select" id="createRole" required>
                                    <option value="user">Standard User</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status *</label>
                                <select class="form-select" id="createStatus" required>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="pin-group">
                            <label class="form-label">Set 4-Digit PIN *</label>
                            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 12px;">
                                This PIN will be required for user transactions
                            </p>
                            <div class="pin-input-container">
                                <input type="password" maxlength="1" class="pin-input" id="createPin1" required>
                                <input type="password" maxlength="1" class="pin-input" id="createPin2" required>
                                <input type="password" maxlength="1" class="pin-input" id="createPin3" required>
                                <input type="password" maxlength="1" class="pin-input" id="createPin4" required>
                            </div>
                        </div>
                        
                        <div class="balance-group">
                            <div class="form-group">
                                <label class="form-label">Checking Balance</label>
                                <input type="number" class="form-input" id="createCheckingBalance" value="1000" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Savings Balance</label>
                                <input type="number" class="form-input" id="createSavingsBalance" value="5000" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Investment Balance</label>
                                <input type="number" class="form-input" id="createInvestmentBalance" value="25000" step="0.01">
                            </div>
                        </div>
                        
                        <div class="profile-picture-section">
                            <div class="profile-preview" id="createProfilePreview">
                                <span id="createProfileInitials">JD</span>
                                <img id="createProfileImage" src="" alt="Profile Picture" style="display: none;">
                            </div>
                            <button type="button" class="upload-btn" id="createUploadPictureBtn">
                                <i class="fas fa-upload"></i> Upload Profile Picture
                            </button>
                            <input type="hidden" id="createProfilePictureUrl">
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" id="cancelCreateBtn">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create User</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit User</h2>
                <button class="modal-close" id="closeEditModal">&times;</button>
            </div>
            <div class="modal-content" id="editUserContent">
                <!-- Edit form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal-overlay" id="resetPasswordModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Reset User Password</h2>
                <button class="modal-close" id="closePasswordModal">&times;</button>
            </div>
            <div class="modal-content" id="resetPasswordContent">
                <!-- Password reset form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal-overlay" id="editTransactionModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Transaction</h2>
                <button class="modal-close" id="closeTransactionModal">&times;</button>
            </div>
            <div class="modal-content" id="editTransactionContent">
                <!-- Transaction edit form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Edit Balance Modal -->
    <div class="modal-overlay" id="editBalanceModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Account Balances</h2>
                <button class="modal-close" id="closeBalanceModal">&times;</button>
            </div>
            <div class="modal-content" id="editBalanceContent">
                <!-- Balance edit form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Edit PIN Modal -->
    <div class="modal-overlay" id="editPinModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit User PIN</h2>
                <button class="modal-close" id="closePinModal">&times;</button>
            </div>
            <div class="modal-content" id="editPinContent">
                <!-- PIN edit form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal-overlay" id="addTransactionModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Transaction</h2>
                <button class="modal-close" id="closeAddTransactionModal">&times;</button>
            </div>
            <div class="modal-content" id="addTransactionContent">
                <!-- Add transaction form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toastNotification">
        <div class="toast-icon" id="toastIcon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title" id="toastTitle">Notification</div>
            <div class="toastMessage" id="toastMessage">This is a notification message.</div>
        </div>
        <button class="toast-close" id="toastClose">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // ==============================
        // FIREBASE CONFIGURATION
        // ==============================
        const firebaseConfig = {
            apiKey: "AIzaSyDfVYuGUWrW528Nk_gRaIulalZ1AUalqPw",
            authDomain: "lumiere-bank.firebaseapp.com",
            projectId: "lumiere-bank",
            storageBucket: "lumiere-bank.firebasestorage.app",
            messagingSenderId: "16422937370",
            appId: "1:16422937370:web:9297b9d9f6834ca33b02a3",
            measurementId: "G-N6JBRJ339S"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==============================
        // CLOUDINARY CONFIGURATION
        // ==============================
        const cloudinaryConfig = {
            cloudName: 'dzy5eio5y',
            uploadPreset: 'bitboost'
        };

        // ==============================
        // ADMIN CREDENTIALS
        // ==============================
        const ADMIN_CREDENTIALS = {
            email: "admin@gmail.com",
            password: "adminpassword"
        };

        // ==============================
        // GLOBAL VARIABLES
        // ==============================
        let currentAdmin = null;
        let adminData = null;
        let allUsers = [];
        let allTransactions = [];
        let cloudinaryWidget = null;
        let cloudinaryWidgetContext = 'create';
        let currentEditUserId = null;
        let currentEditTransactionId = null;
        let currentPasswordResetUserId = null;

        // ==============================
        // INITIALIZATION
        // ==============================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Admin Dashboard loading...");
            
            // Initialize Cloudinary
            initCloudinaryWidget();
            
            // Initialize event listeners
            initEventListeners();
            
            // Initialize PIN inputs
            initPinInputs();
            
            // Check if already logged in
            checkExistingLogin();
            
            // Set up auth state listener to prevent suspended users from logging in
            setupAuthStateListener();
        });

        // ==============================
        // FIX 1: ENFORCE USER SUSPENSION
        // ==============================
        function setupAuthStateListener() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Check if user is trying to log in
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        
                        // If user is suspended, sign them out immediately
                        if (userData.status === 'suspended') {
                            await auth.signOut();
                            showToast('Account Suspended', 'Your account has been suspended. Please contact administrator.', 'error');
                            
                            // Also sign out from any app sessions
                            localStorage.removeItem('userLoggedIn');
                        }
                        
                        // If user is inactive, warn but allow login? You can customize this
                        if (userData.status === 'inactive') {
                            showToast('Inactive Account', 'Your account is inactive. Limited access.', 'warning');
                        }
                    }
                }
            });
        }

        // ==============================
        // AUTHENTICATION FUNCTIONS
        // ==============================
        function checkExistingLogin() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            const adminEmail = localStorage.getItem('adminEmail');
            
            if (isLoggedIn && adminEmail === ADMIN_CREDENTIALS.email) {
                // User is already logged in, show dashboard
                showAdminDashboard();
            } else {
                // Show login page
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminDashboard').style.display = 'none';
        }

        function showAdminDashboard() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('adminMain').classList.add('show');
            
            // Update admin info immediately
            updateAdminInfo();
            
            // Load dashboard data
            loadAdminDashboard();
        }

        async function handleLogin(email, password) {
            const loginError = document.getElementById('loginError');
            const errorMessage = document.getElementById('errorMessage');
            const loginBtn = document.getElementById('loginBtn');
            const originalBtnText = loginBtn.innerHTML;
            
            // Show loading state
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
            loginBtn.disabled = true;
            
            try {
                // Authenticate with Firebase
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Check if user is admin
                if (email === ADMIN_CREDENTIALS.email) {
                    // Successful admin login
                    loginError.classList.remove('show');
                    
                    // Store login state
                    localStorage.setItem('adminLoggedIn', 'true');
                    localStorage.setItem('adminEmail', email);
                    localStorage.setItem('adminName', 'Admin User');
                    
                    // Create mock admin data
                    adminData = {
                        firstName: "Admin",
                        lastName: "User",
                        email: email,
                        role: "admin",
                        status: "active"
                    };
                    
                    showToast('Success', 'Login successful! Loading dashboard...', 'success');
                    
                    // Show dashboard
                    setTimeout(() => {
                        showAdminDashboard();
                        loginBtn.innerHTML = originalBtnText;
                        loginBtn.disabled = false;
                    }, 1000);
                } else {
                    // Non-admin trying to login
                    await auth.signOut();
                    errorMessage.textContent = 'Access denied. Admin credentials required.';
                    loginError.classList.add('show');
                    loginBtn.innerHTML = originalBtnText;
                    loginBtn.disabled = false;
                }
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Failed login
                errorMessage.textContent = 'Invalid email or password. Please try again.';
                loginError.classList.add('show');
                
                // Reset button state
                loginBtn.innerHTML = originalBtnText;
                loginBtn.disabled = false;
                
                // Clear password field
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        }

        function handleLogout() {
            // Sign out from Firebase
            auth.signOut().then(() => {
                // Clear login state
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminEmail');
                localStorage.removeItem('adminName');
                
                // Reset data
                currentAdmin = null;
                adminData = null;
                allUsers = [];
                allTransactions = [];
                
                // Show login page
                showLoginPage();
                
                // Reset login form
                document.getElementById('loginForm').reset();
                
                // Show logout message
                showToast('Success', 'Logged out successfully!', 'success');
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        }

        // ==============================
        // DASHBOARD LOADING
        // ==============================
        async function loadAdminDashboard() {
            try {
                // Show loading spinner
                document.getElementById('loadingSpinner').style.display = 'flex';
                
                // Update admin info
                updateAdminInfo();
                
                // Load all users from Firestore
                await loadAllUsers();
                
                // Load all transactions from Firestore
                await loadAllTransactions();
                
                // Update dashboard stats
                updateDashboardStats();
                
                // Update activity log
                updateActivityLog();
                
                // Hide loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
                
                // Populate user filter for transactions
                populateUserFilter();
                
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
                showToast('Error', 'Failed to load dashboard data.', 'error');
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        async function loadAllUsers() {
            try {
                const usersSnapshot = await db.collection('users')
                    .where('status', '!=', 'deleted')
                    .get();
                
                allUsers = [];
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    allUsers.push({
                        id: doc.id,
                        firstName: userData.firstName || '',
                        lastName: userData.lastName || '',
                        email: userData.email || '',
                        phone: userData.phone || '',
                        role: userData.role || 'user',
                        status: userData.status || 'inactive',
                        profilePicture: userData.profilePicture || null,
                        accountNumber: userData.accountNumber || userData.accounts?.checking?.accountNumber || 'Not Set',
                        transactionApproval: userData.transactionApproval !== undefined ? userData.transactionApproval : true,
                        pin: userData.pin || null,
                        pinUpdatedAt: userData.pinUpdatedAt || null,
                        lastLogin: userData.lastLogin || null,
                        accounts: userData.accounts || {
                            checking: { balance: 0, accountNumber: '' },
                            savings: { balance: 0 },
                            investment: { balance: 0 }
                        },
                        createdAt: userData.createdAt || new Date().toISOString()
                    });
                });
                console.log('Loaded all users:', allUsers.length);
                updateUsersTable();
                updateBalancesTable();
                updatePinsTable();
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Error', 'Failed to load users.', 'error');
            }
        }

        async function loadAllTransactions() {
            try {
                allTransactions = [];
                
                for (const user of allUsers) {
                    const transactionsSnapshot = await db.collection('users')
                        .doc(user.id)
                        .collection('transactions')
                        .orderBy('date', 'desc')
                        .limit(50)
                        .get();
                    
                    transactionsSnapshot.forEach(doc => {
                        allTransactions.push({
                            id: doc.id,
                            userId: user.id,
                            userName: `${user.firstName} ${user.lastName}`,
                            userEmail: user.email,
                            ...doc.data()
                        });
                    });
                }
                
                console.log('Loaded all transactions:', allTransactions.length);
                updateTransactionsTable();
                
            } catch (error) {
                console.error('Error loading transactions:', error);
                showToast('Error', 'Failed to load transactions.', 'error');
            }
        }

        // ==============================
        // FIX 2: TRANSACTION APPROVAL TOGGLE - COMPLETELY FIXED
        // ==============================
        async function toggleTransactionApproval(userId, approved) {
            try {
                showToast('Info', `${approved ? 'Enabling' : 'Disabling'} transaction approval...`, 'info');
                
                // 1. Update the user's transaction approval flag in Firestore
                await db.collection('users').doc(userId).update({
                    transactionApproval: approved
                });
                
                // 2. Update local user data
                const userIndex = allUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex].transactionApproval = approved;
                }
                
                // 3. Handle pending transactions based on approval status
                try {
                    // Get ALL pending transactions for this user
                    const pendingTransactions = await db.collection('users')
                        .doc(userId)
                        .collection('transactions')
                        .where('status', '==', 'pending')
                        .get();
                    
                    if (approved === true) {
                        // When turning ON approval: Auto-approve ALL pending transactions
                        if (!pendingTransactions.empty) {
                            const batch = db.batch();
                            let updatedCount = 0;
                            
                            pendingTransactions.forEach(doc => {
                                batch.update(doc.ref, {
                                    status: 'completed',
                                    updatedAt: new Date().toISOString(),
                                    approvedAt: new Date().toISOString(),
                                    approvedBy: 'admin',
                                    approvalMethod: 'auto-approve'
                                });
                                updatedCount++;
                            });
                            
                            await batch.commit();
                            
                            // Update local transactions array
                            allTransactions.forEach(t => {
                                if (t.userId === userId && t.status === 'pending') {
                                    t.status = 'completed';
                                    t.approvedAt = new Date().toISOString();
                                    t.approvedBy = 'admin';
                                    t.approvalMethod = 'auto-approve';
                                }
                            });
                            
                            showToast('Success', `âœ“ Transaction approval ENABLED\nâœ“ ${updatedCount} pending transaction(s) automatically approved`, 'success');
                        } else {
                            showToast('Success', 'Transaction approval enabled. No pending transactions found.', 'success');
                        }
                    } else {
                        // When turning OFF approval: Keep existing pending transactions as pending
                        // DO NOT auto-approve or auto-reject them
                        showToast('Success', 'Transaction approval DISABLED. New transactions will be pending.', 'success');
                        
                        // Log the change but don't modify existing transactions
                        console.log(`Transaction approval disabled for user ${userId}. ${pendingTransactions.size} pending transactions remain unchanged.`);
                    }
                    
                } catch (pendingError) {
                    console.error('Error handling pending transactions:', pendingError);
                    if (approved) {
                        showToast('Warning', 'User approval enabled but some pending transactions could not be auto-approved.', 'warning');
                    }
                }
                
                // 4. Update UI tables
                updateUsersTable();
                updateTransactionsTable();
                updateActivityLog();
                
                // 5. Log activity
                const userEmail = userIndex !== -1 ? allUsers[userIndex].email : 'Unknown';
                logAdminActivity(`Transaction approval ${approved ? 'ENABLED' : 'DISABLED'} for user: ${userEmail}`);
                
            } catch (error) {
                console.error('Error updating transaction approval:', error);
                showToast('Error', 'Failed to update transaction approval. Please try again.', 'error');
                
                // Revert the toggle in UI if there was an error
                const row = document.querySelector(`#usersTableBody tr:has(button[onclick*="'${userId}'"])`);
                if (row) {
                    const toggle = row.querySelector('.toggle-switch input');
                    if (toggle) {
                        toggle.checked = !approved;
                    }
                }
            }
        }

        // ==============================
        // FIX 3: PASSWORD RESET - NOW WORKING!
        // ==============================
        async function showResetPasswordModal(userId) {
            try {
                const user = allUsers.find(u => u.id === userId);
                if (!user) {
                    showToast('Error', 'User not found.', 'error');
                    return;
                }
                
                currentPasswordResetUserId = userId;
                
                const modalContent = document.getElementById('resetPasswordContent');
                
                modalContent.innerHTML = `
                    <form id="resetPasswordForm">
                        <div class="form-group">
                            <label class="form-label">User</label>
                            <input type="text" class="form-input" value="${user.firstName} ${user.lastName} (${user.email})" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Admin Password *</label>
                            <input type="password" class="form-input" id="adminAuthPassword" required 
                                   placeholder="Enter your admin password to authorize">
                            <small style="color: var(--text-light); font-size: 12px;">
                                Required for security verification
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">New Password *</label>
                            <input type="password" class="form-input" id="resetNewPassword" required minlength="8">
                            <small style="color: var(--text-light); font-size: 12px;">Minimum 8 characters</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Confirm New Password *</label>
                            <input type="password" class="form-input" id="resetConfirmPassword" required>
                        </div>
                        
                        <div class="password-requirements">
                            <div class="requirement-item" id="reqLength">
                                <i class="fas fa-circle"></i> At least 8 characters
                            </div>
                            <div class="requirement-item" id="reqMatch">
                                <i class="fas fa-circle"></i> Passwords match
                            </div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Password</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('resetPasswordModal').classList.add('active');
                
                // Add password validation listeners
                const newPassword = document.getElementById('resetNewPassword');
                const confirmPassword = document.getElementById('resetConfirmPassword');
                
                function validatePassword() {
                    const lengthValid = newPassword.value.length >= 8;
                    const matchValid = newPassword.value === confirmPassword.value && newPassword.value.length > 0;
                    
                    document.getElementById('reqLength').className = `requirement-item ${lengthValid ? 'valid' : ''}`;
                    document.getElementById('reqMatch').className = `requirement-item ${matchValid ? 'valid' : ''}`;
                    
                    if (lengthValid) {
                        document.getElementById('reqLength').innerHTML = '<i class="fas fa-check-circle"></i> At least 8 characters';
                    } else {
                        document.getElementById('reqLength').innerHTML = '<i class="fas fa-circle"></i> At least 8 characters';
                    }
                    
                    if (matchValid) {
                        document.getElementById('reqMatch').innerHTML = '<i class="fas fa-check-circle"></i> Passwords match';
                    } else {
                        document.getElementById('reqMatch').innerHTML = '<i class="fas fa-circle"></i> Passwords match';
                    }
                }
                
                newPassword.addEventListener('input', validatePassword);
                confirmPassword.addEventListener('input', validatePassword);
                
                document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await updateUserPassword(userId);
                });
                
            } catch (error) {
                console.error('Error showing password reset modal:', error);
                showToast('Error', 'Failed to open password reset form.', 'error');
            }
        }

        async function updateUserPassword(userId) {
            try {
                // Get form values
                const adminPassword = document.getElementById('adminAuthPassword').value;
                const newPassword = document.getElementById('resetNewPassword').value;
                const confirmPassword = document.getElementById('resetConfirmPassword').value;
                const user = allUsers.find(u => u.id === userId);
                
                if (!user) {
                    showToast('Error', 'User not found.', 'error');
                    return;
                }
                
                // Validation
                if (!adminPassword) {
                    showToast('Error', 'Admin password is required for authorization.', 'error');
                    return;
                }
                
                if (newPassword.length < 8) {
                    showToast('Error', 'Password must be at least 8 characters long.', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showToast('Error', 'Passwords do not match.', 'error');
                    return;
                }
                
                showToast('Info', 'Verifying admin credentials...', 'info');
                
                // Verify admin credentials by signing in
                await auth.signInWithEmailAndPassword(ADMIN_CREDENTIALS.email, adminPassword);
                
                showToast('Info', 'Admin verified. Resetting user password...', 'info');
                
                // ===== FIXED: PROPER PASSWORD RESET METHOD =====
                // 1. Send password reset email
                await auth.sendPasswordResetEmail(user.email);
                
                // 2. Log the password reset request
                console.log(`Password reset email sent to: ${user.email}`);
                
                // 3. Update user document to indicate password reset
                await db.collection('users').doc(userId).update({
                    passwordResetRequested: new Date().toISOString(),
                    passwordResetRequestedBy: ADMIN_CREDENTIALS.email
                });
                
                // Show success message
                showToast('Success', `âœ“ Password reset email sent to ${user.email}\nâœ“ User will receive instructions to set new password`, 'success');
                
                // Log activity
                logAdminActivity(`Password reset requested for user: ${user.email}`);
                
                // Close modal
                closePasswordModal();
                
            } catch (error) {
                console.error('Error resetting password:', error);
                
                let errorMessage = 'Failed to reset password. ';
                
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect admin password. Please try again.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'User email not found in authentication system.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many attempts. Please try again later.';
                } else {
                    errorMessage += error.message;
                }
                
                showToast('Error', errorMessage, 'error');
            }
        }

        // ==============================
        // FIX 4: CLOUDINARY WIDGET WITH CONTEXT
        // ==============================
        function initCloudinaryWidget() {
            try {
                if (typeof cloudinary === 'undefined') {
                    console.error('Cloudinary SDK not loaded');
                    return;
                }
                
                cloudinaryWidget = cloudinary.createUploadWidget({
                    cloudName: 'dzy5eio5y',
                    uploadPreset: 'bitboost',
                    sources: ['local', 'url', 'camera'],
                    multiple: false,
                    cropping: true,
                    croppingAspectRatio: 1,
                    croppingShowBackButton: true,
                    maxFileSize: 5000000,
                    styles: {
                        palette: {
                            window: "#FFFFFF",
                            windowBorder: "#673AB7",
                            tabIcon: "#673AB7",
                            menuIcons: "#673AB7",
                            textDark: "#121212",
                            textLight: "#FFFFFF",
                            link: "#673AB7",
                            action: "#FF620C",
                            inactiveTabIcon: "#666666",
                            error: "#F44235",
                            inProgress: "#673AB7",
                            complete: "#20B832",
                            sourceBg: "#F5F7FA"
                        }
                    }
                }, function(error, result) {
                    if (!error && result && result.event === "success") {
                        console.log('Cloudinary upload successful:', result.info);
                        
                        const imageUrl = result.info.secure_url;
                        
                        // Handle based on context
                        if (cloudinaryWidgetContext === 'create') {
                            document.getElementById('createProfilePictureUrl').value = imageUrl;
                            const previewImg = document.getElementById('createProfileImage');
                            const previewInitials = document.getElementById('createProfileInitials');
                            
                            previewImg.src = imageUrl;
                            previewImg.style.display = 'block';
                            previewInitials.style.display = 'none';
                            
                            showToast('Success', 'Profile picture uploaded successfully!', 'success');
                        } else if (cloudinaryWidgetContext === 'edit') {
                            document.getElementById('editProfilePictureUrl').value = imageUrl;
                            const editPreviewImg = document.getElementById('editProfileImage');
                            const editPreviewInitials = document.getElementById('editProfileInitials');
                            
                            if (editPreviewImg && editPreviewInitials) {
                                editPreviewImg.src = imageUrl;
                                editPreviewImg.style.display = 'block';
                                editPreviewInitials.style.display = 'none';
                            }
                            
                            showToast('Success', 'Profile picture updated successfully!', 'success');
                        }
                        
                        // Reset context
                        cloudinaryWidgetContext = 'create';
                    } else if (error) {
                        console.error('Cloudinary upload error:', error);
                        showToast('Error', 'Failed to upload image. Please try again.', 'error');
                    }
                });
                
                console.log('Cloudinary widget initialized successfully');
            } catch (error) {
                console.error('Error initializing Cloudinary:', error);
                showToast('Error', 'Image upload service is not available.', 'error');
            }
        }

        function openCloudinaryWidget(context = 'create') {
            try {
                if (cloudinaryWidget) {
                    console.log('Opening Cloudinary widget for context:', context);
                    cloudinaryWidgetContext = context; // Store the context
                    cloudinaryWidget.open();
                } else {
                    console.error('Cloudinary widget not initialized');
                    showToast('Error', 'Image upload service is not available. Please refresh the page.', 'error');
                    initCloudinaryWidget();
                }
            } catch (error) {
                console.error('Error opening Cloudinary widget:', error);
                showToast('Error', 'Failed to open image uploader.', 'error');
            }
        }

        // ==============================
        // UI UPDATES
        // ==============================
        function updateAdminInfo() {
            const adminName = localStorage.getItem('adminName') || 'Admin User';
            document.getElementById('adminName').textContent = adminName;
            
            const initials = adminName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('adminAvatar').textContent = initials;
        }

        function updateDashboardStats() {
            // Total users
            document.getElementById('totalUsers').textContent = allUsers.length;
            
            // Active users
            const activeUsers = allUsers.filter(user => user.status === 'active');
            document.getElementById('activeUsers').textContent = activeUsers.length;
            
            // Transactions today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTransactions = allTransactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate >= today;
            });
            document.getElementById('totalTransactions').textContent = todayTransactions.length;
            
            // Total bank balance
            let totalBalance = 0;
            allUsers.forEach(user => {
                if (user.accounts) {
                    totalBalance += (user.accounts.checking?.balance || 0);
                    totalBalance += (user.accounts.savings?.balance || 0);
                    totalBalance += (user.accounts.investment?.balance || 0);
                }
            });
            document.getElementById('totalBalance').textContent = 
                new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(totalBalance);
        }

        function updateActivityLog() {
            const activityList = document.getElementById('activityList');
            activityList.innerHTML = '';
            
            // Add login activity
            const loginActivity = document.createElement('div');
            loginActivity.className = 'activity-item';
            loginActivity.innerHTML = `
                <div class="activity-icon" style="background-color: rgba(103, 58, 183, 0.1); color: var(--admin-purple);">
                    <i class="fas fa-sign-in-alt"></i>
                </div>
                <div class="activity-details">
                    <div class="activity-title">Admin logged in successfully</div>
                    <div class="activity-time">${new Date().toLocaleString()} â€¢ Admin Dashboard</div>
                </div>
            `;
            activityList.appendChild(loginActivity);
            
            // Sort transactions by date (newest first)
            const recentTransactions = [...allTransactions]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 9);
            
            recentTransactions.forEach(transaction => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                const icon = transaction.type === 'credit' ? 'fa-arrow-down' : 'fa-arrow-up';
                const color = transaction.type === 'credit' ? 'var(--success-green)' : 'var(--danger-red)';
                
                activityItem.innerHTML = `
                    <div class="activity-icon" style="background-color: ${color}20; color: ${color};">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="activity-details">
                        <div class="activity-title">
                            ${transaction.userName} - ${transaction.description}
                        </div>
                        <div class="activity-time">
                            ${new Date(transaction.date).toLocaleString()} â€¢ 
                            ${transaction.type === 'credit' ? '+' : '-'}$${Math.abs(transaction.amount).toFixed(2)} â€¢ 
                            <span style="color: ${transaction.status === 'completed' ? 'var(--success-green)' : 'var(--warning-orange)'};">${transaction.status}</span>
                        </div>
                    </div>
                `;
                
                activityList.appendChild(activityItem);
            });
        }

        function logAdminActivity(action) {
            // Add activity to local storage or Firestore
            console.log('Admin Activity:', action);
            
            // Update activity log if on dashboard
            if (document.getElementById('dashboardSection').classList.contains('active')) {
                updateActivityLog();
            }
        }

        function updateUsersTable() {
            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = '';
            
            if (allUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; display: block; color: var(--light-blue);"></i>
                            <div>No users found. Create your first user in the "Create User" section.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            allUsers.forEach(user => {
                const row = document.createElement('tr');
                
                // User avatar and name
                let avatarHtml = `<div class="user-avatar-small">`;
                if (user.profilePicture) {
                    avatarHtml += `<img src="${user.profilePicture}" alt="${user.firstName}">`;
                } else {
                    const initials = (user.firstName?.[0] || '') + (user.lastName?.[0] || '');
                    avatarHtml += initials.toUpperCase();
                }
                avatarHtml += `</div>`;
                
                // Account number
                const accountNumber = user.accountNumber || user.accounts?.checking?.accountNumber || 'Not Set';
                const formattedAccountNumber = accountNumber.length > 12 ? 
                    `${accountNumber.substring(0, 4)} **** **** ${accountNumber.substring(accountNumber.length - 4)}` : 
                    accountNumber;
                
                // Transaction approval status
                const transactionApproval = user.transactionApproval !== false;
                
                // PIN status
                const pinStatus = user.pin ? 
                    `<span style="color: var(--success-green); font-weight: 600;">âœ“ Set</span>` : 
                    `<span style="color: var(--danger-red); font-weight: 600;">âœ— Not Set</span>`;
                
                // Last login
                const lastLogin = user.lastLogin ? 
                    new Date(user.lastLogin).toLocaleDateString() : 'Never';
                
                // Determine status class
                let statusClass = '';
                if (user.status === 'active') statusClass = 'status-active';
                else if (user.status === 'inactive') statusClass = 'status-inactive';
                else if (user.status === 'suspended') statusClass = 'status-suspended';
                
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            ${avatarHtml}
                            <div>
                                <div class="user-name">${user.firstName} ${user.lastName}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <div class="account-number">${formattedAccountNumber}</div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="toggle-switch">
                                <input type="checkbox" ${transactionApproval ? 'checked' : ''} 
                                       onchange="toggleTransactionApproval('${user.id}', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="transaction-status-label ${transactionApproval ? 'approved' : 'pending'}">
                                <i class="fas ${transactionApproval ? 'fa-check-circle' : 'fa-clock'}"></i>
                                ${transactionApproval ? 'Approved' : 'Pending'}
                            </span>
                        </div>
                    </td>
                    <td><span class="user-status ${statusClass}">${user.status || 'inactive'}</span></td>
                    <td><span class="role-badge ${user.role === 'admin' ? 'role-admin' : 'role-user'}">${user.role || 'user'}</span></td>
                    <td>
                        <div style="font-size: 11px;">
                            ${user.accounts?.checking?.balance !== undefined ? 'âœ“ Checking<br>' : ''}
                            ${user.accounts?.savings?.balance !== undefined ? 'âœ“ Savings<br>' : ''}
                            ${user.accounts?.investment?.balance !== undefined ? 'âœ“ Investment' : ''}
                        </div>
                    </td>
                    <td>${pinStatus}</td>
                    <td>${lastLogin}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editUser('${user.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn password" onclick="showResetPasswordModal('${user.id}')">
                                <i class="fas fa-key"></i> Reset Pass
                            </button>
                            <button class="action-btn delete" onclick="deleteUser('${user.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function updateTransactionsTable() {
            const tableBody = document.getElementById('transactionsTableBody');
            tableBody.innerHTML = '';
            
            if (allTransactions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fas fa-exchange-alt" style="font-size: 48px; margin-bottom: 16px; display: block; color: var(--light-blue);"></i>
                            <div>No transactions found.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Apply filters
            let filteredTransactions = [...allTransactions];
            
            const userFilter = document.getElementById('transactionUserFilter').value;
            if (userFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.userId === userFilter);
            }
            
            const typeFilter = document.getElementById('transactionTypeFilter').value;
            if (typeFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.type === typeFilter);
            }
            
            const dateFrom = document.getElementById('dateFromFilter').value;
            if (dateFrom) {
                filteredTransactions = filteredTransactions.filter(t => 
                    new Date(t.date) >= new Date(dateFrom)
                );
            }
            
            const dateTo = document.getElementById('dateToFilter').value;
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filteredTransactions = filteredTransactions.filter(t => 
                    new Date(t.date) <= toDate
                );
            }
            
            filteredTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                const date = new Date(transaction.date);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar-small" style="background-color: ${transaction.type === 'credit' ? 'rgba(13, 157, 107, 0.1)' : 'rgba(211, 47, 47, 0.1)'}; color: ${transaction.type === 'credit' ? 'var(--success-green)' : 'var(--danger-red)'};">
                                ${transaction.userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}
                            </div>
                            <div>
                                <div class="user-name">${transaction.userName}</div>
                                <div class="user-email">${transaction.userEmail}</div>
                            </div>
                        </div>
                    </td>
                    <td><span style="color: ${transaction.type === 'credit' ? 'var(--success-green)' : 'var(--danger-red)'}; font-weight: 600;">${transaction.type.toUpperCase()}</span></td>
                    <td style="font-weight: 600; color: ${transaction.type === 'credit' ? 'var(--success-green)' : 'var(--danger-red)'};">${transaction.type === 'credit' ? '+' : '-'}$${Math.abs(transaction.amount).toFixed(2)}</td>
                    <td>${transaction.description}</td>
                    <td>${transaction.bank || 'N/A'}</td>
                    <td>${transaction.recipientName || 'N/A'}</td>
                    <td>
                        <div>${formattedDate}</div>
                        <div style="font-size: 11px; color: var(--text-light);">${formattedTime}</div>
                    </td>
                    <td>
                        <span style="color: ${transaction.status === 'completed' ? 'var(--success-green)' : transaction.status === 'pending' ? 'var(--warning-orange)' : 'var(--danger-red)'};">
                            ${transaction.status}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editTransaction('${transaction.userId}', '${transaction.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete" onclick="deleteTransaction('${transaction.userId}', '${transaction.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function updateBalancesTable() {
            const tableBody = document.getElementById('balancesTableBody');
            tableBody.innerHTML = '';
            
            if (allUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fas fa-university" style="font-size: 48px; margin-bottom: 16px; display: block; color: var(--light-blue);"></i>
                            <div>No users found. Create your first user to see balances.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            allUsers.forEach(user => {
                const row = document.createElement('tr');
                
                const checkingBalance = user.accounts?.checking?.balance || 0;
                const savingsBalance = user.accounts?.savings?.balance || 0;
                const investmentBalance = user.accounts?.investment?.balance || 0;
                const totalBalance = checkingBalance + savingsBalance + investmentBalance;
                
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar-small">
                                ${(user.firstName?.[0] || '') + (user.lastName?.[0] || '')}
                            </div>
                            <div>
                                <div class="user-name">${user.firstName} ${user.lastName}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td style="font-weight: 600;">$${checkingBalance.toFixed(2)}</td>
                    <td style="font-weight: 600;">$${savingsBalance.toFixed(2)}</td>
                    <td style="font-weight: 600;">$${investmentBalance.toFixed(2)}</td>
                    <td style="font-weight: 700; color: var(--primary-blue);">$${totalBalance.toFixed(2)}</td>
                    <td>${user.accounts?.lastUpdated ? new Date(user.accounts.lastUpdated).toLocaleString() : 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editBalance('${user.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn reset" onclick="resetBalances('${user.id}')">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function updatePinsTable() {
            const tableBody = document.getElementById('pinsTableBody');
            tableBody.innerHTML = '';
            
            if (allUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fas fa-key" style="font-size: 48px; margin-bottom: 16px; display: block; color: var(--light-blue);"></i>
                            <div>No users found. Create your first user to manage PINs.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            allUsers.forEach(user => {
                const row = document.createElement('tr');
                
                const accountNumber = user.accountNumber || user.accounts?.checking?.accountNumber || 'Not Set';
                const formattedAccountNumber = accountNumber.length > 12 ? 
                    `${accountNumber.substring(0, 4)} **** **** ${accountNumber.substring(accountNumber.length - 4)}` : 
                    accountNumber;
                
                const pinDisplay = user.pin ? 
                    'â€¢â€¢â€¢â€¢' : 
                    '<span style="color: var(--danger-red);">Not Set</span>';
                
                const pinStatus = user.pin ? 
                    '<span style="color: var(--success-green);">âœ“ Active</span>' : 
                    '<span style="color: var(--danger-red);">âœ— Inactive</span>';
                
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar-small">
                                ${(user.firstName?.[0] || '') + (user.lastName?.[0] || '')}
                            </div>
                            <div>
                                <div class="user-name">${user.firstName} ${user.lastName}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <div class="account-number">${formattedAccountNumber}</div>
                    </td>
                    <td style="font-family: monospace; font-size: 16px; letter-spacing: 2px;">${pinDisplay}</td>
                    <td>${pinStatus}</td>
                    <td>${user.pinUpdatedAt ? new Date(user.pinUpdatedAt).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editPin('${user.id}')">
                                <i class="fas fa-key"></i> Edit PIN
                            </button>
                            ${user.pin ? `
                            <button class="action-btn reset" onclick="resetPin('${user.id}')">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function populateUserFilter() {
            const filter = document.getElementById('transactionUserFilter');
            filter.innerHTML = '<option value="">All Users</option>';
            
            allUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.firstName} ${user.lastName} (${user.email})`;
                filter.appendChild(option);
            });
        }

        // ==============================
        // EDIT FUNCTIONS
        // ==============================
        async function editUser(userId) {
            try {
                const user = allUsers.find(u => u.id === userId);
                if (!user) {
                    showToast('Error', 'User not found.', 'error');
                    return;
                }
                
                currentEditUserId = userId;
                
                const modalContent = document.getElementById('editUserContent');
                modalContent.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                `;
                
                document.getElementById('editUserModal').classList.add('active');
                
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();
                
                const accountNumber = userData.accountNumber || userData.accounts?.checking?.accountNumber || '';
                
                const editForm = document.createElement('form');
                editForm.id = 'editUserForm';
                
                editForm.innerHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-input" id="editFirstName" value="${userData.firstName || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-input" id="editLastName" value="${userData.lastName || ''}" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-input" id="editEmail" value="${userData.email || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="editPhone" value="${userData.phone || ''}">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Account Number *</label>
                            <input type="text" class="form-input" id="editAccountNumber" value="${accountNumber}" required placeholder="e.g., 4500 1234 5678 9012">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Transaction Approval</label>
                            <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="editTransactionApproval" ${userData.transactionApproval !== false ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="transaction-status-label ${userData.transactionApproval !== false ? 'approved' : 'pending'}" id="editTransactionStatusLabel">
                                    <i class="fas ${userData.transactionApproval !== false ? 'fa-check-circle' : 'fa-clock'}"></i>
                                    ${userData.transactionApproval !== false ? 'Approved' : 'Pending'}
                                </span>
                            </div>
                            <small style="color: var(--text-light); font-size: 12px;">
                                When off, all user transactions will be marked as pending
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Role *</label>
                            <select class="form-select" id="editRole" required>
                                <option value="user" ${userData.role === 'user' ? 'selected' : ''}>Standard User</option>
                                <option value="admin" ${userData.role === 'admin' ? 'selected' : ''}>Administrator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-select" id="editStatus" required>
                                <option value="active" ${userData.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${userData.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                <option value="suspended" ${userData.status === 'suspended' ? 'selected' : ''}>Suspended</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="profile-picture-section">
                        <div class="profile-preview" id="editProfilePreview">
                            <span id="editProfileInitials">${(userData.firstName?.[0] || '') + (userData.lastName?.[0] || '')}</span>
                            <img id="editProfileImage" src="${userData.profilePicture || ''}" alt="Profile Picture" style="${userData.profilePicture ? 'display: block;' : 'display: none;'}">
                        </div>
                        <button type="button" class="upload-btn" id="editUploadPictureBtn">
                            <i class="fas fa-upload"></i> Upload Profile Picture
                        </button>
                        <input type="hidden" id="editProfilePictureUrl" value="${userData.profilePicture || ''}">
                        ${userData.profilePicture ? `
                        <button type="button" class="btn btn-danger" style="margin-top: 8px;" id="removeProfilePictureBtn">
                            <i class="fas fa-trash"></i> Remove Picture
                        </button>
                        ` : ''}
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="showResetPasswordModal('${userId}')">
                            <i class="fas fa-key"></i> Reset Password
                        </button>
                        <button type="button" class="btn btn-danger" onclick="deleteUser('${userId}')">Delete User</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                `;
                
                modalContent.innerHTML = '';
                modalContent.appendChild(editForm);
                
                // Set up event listeners for edit form
                document.getElementById('editUploadPictureBtn').addEventListener('click', () => {
                    openCloudinaryWidget('edit');
                });
                
                const removeBtn = document.getElementById('removeProfilePictureBtn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        document.getElementById('editProfilePictureUrl').value = '';
                        document.getElementById('editProfileImage').style.display = 'none';
                        document.getElementById('editProfileInitials').style.display = 'block';
                        showToast('Success', 'Profile picture removed.', 'success');
                    });
                }
                
                document.getElementById('editTransactionApproval').addEventListener('change', function() {
                    const label = document.getElementById('editTransactionStatusLabel');
                    if (this.checked) {
                        label.innerHTML = '<i class="fas fa-check-circle"></i> Approved';
                        label.className = 'transaction-status-label approved';
                    } else {
                        label.innerHTML = '<i class="fas fa-clock"></i> Pending';
                        label.className = 'transaction-status-label pending';
                    }
                });
                
                document.getElementById('editUserForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveUserEdits(userId);
                });
                
            } catch (error) {
                console.error('Error loading user for editing:', error);
                showToast('Error', 'Failed to load user data.', 'error');
            }
        }

        async function saveUserEdits(userId) {
            try {
                const firstName = document.getElementById('editFirstName').value.trim();
                const lastName = document.getElementById('editLastName').value.trim();
                const email = document.getElementById('editEmail').value.trim();
                const phone = document.getElementById('editPhone').value.trim();
                const accountNumber = document.getElementById('editAccountNumber').value.trim();
                const transactionApproval = document.getElementById('editTransactionApproval').checked;
                const role = document.getElementById('editRole').value;
                const status = document.getElementById('editStatus').value;
                const profilePicture = document.getElementById('editProfilePictureUrl').value;
                
                if (!firstName || !lastName || !email || !accountNumber) {
                    showToast('Error', 'Please fill in all required fields.', 'error');
                    return;
                }
                
                const updateData = {
                    firstName,
                    lastName,
                    email: email.toLowerCase(),
                    phone,
                    accountNumber,
                    transactionApproval,
                    role,
                    status,
                    profilePicture: profilePicture || null,
                    updatedAt: new Date().toISOString(),
                    'accounts.checking.accountNumber': accountNumber,
                    'accounts.checking.fullNumber': accountNumber,
                    'accounts.savings.accountNumber': `â€¢â€¢â€¢â€¢ ${accountNumber.substring(accountNumber.length - 4)}`,
                    'accounts.savings.fullNumber': accountNumber.replace(/\d{4}(?= \d{4})/g, '****')
                };
                
                await db.collection('users').doc(userId).update(updateData);
                
                const userIndex = allUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex].firstName = firstName;
                    allUsers[userIndex].lastName = lastName;
                    allUsers[userIndex].email = email.toLowerCase();
                    allUsers[userIndex].phone = phone;
                    allUsers[userIndex].accountNumber = accountNumber;
                    allUsers[userIndex].transactionApproval = transactionApproval;
                    allUsers[userIndex].role = role;
                    allUsers[userIndex].status = status;
                    allUsers[userIndex].profilePicture = profilePicture || null;
                    
                    if (allUsers[userIndex].accounts) {
                        if (!allUsers[userIndex].accounts.checking) {
                            allUsers[userIndex].accounts.checking = {};
                        }
                        allUsers[userIndex].accounts.checking.accountNumber = accountNumber;
                        allUsers[userIndex].accounts.checking.fullNumber = accountNumber;
                        
                        if (!allUsers[userIndex].accounts.savings) {
                            allUsers[userIndex].accounts.savings = {};
                        }
                        allUsers[userIndex].accounts.savings.accountNumber = `â€¢â€¢â€¢â€¢ ${accountNumber.substring(accountNumber.length - 4)}`;
                        allUsers[userIndex].accounts.savings.fullNumber = accountNumber.replace(/\d{4}(?= \d{4})/g, '****');
                    }
                }
                
                // If transaction approval was turned ON, update pending transactions
                if (transactionApproval === true) {
                    try {
                        const pendingTransactions = await db.collection('users')
                            .doc(userId)
                            .collection('transactions')
                            .where('status', '==', 'pending')
                            .get();
                        
                        if (!pendingTransactions.empty) {
                            const batch = db.batch();
                            let updatedCount = 0;
                            
                            pendingTransactions.forEach(doc => {
                                batch.update(doc.ref, {
                                    status: 'completed',
                                    updatedAt: new Date().toISOString(),
                                    approvedAt: new Date().toISOString(),
                                    approvedBy: 'admin',
                                    approvalMethod: 'auto-approve'
                                });
                                updatedCount++;
                            });
                            
                            await batch.commit();
                            
                            allTransactions.forEach(t => {
                                if (t.userId === userId && t.status === 'pending') {
                                    t.status = 'completed';
                                    t.approvedAt = new Date().toISOString();
                                    t.approvedBy = 'admin';
                                    t.approvalMethod = 'auto-approve';
                                }
                            });
                            
                            showToast('Success', `User updated successfully! ${updatedCount} pending transaction(s) auto-approved.`, 'success');
                        } else {
                            showToast('Success', 'User updated successfully!', 'success');
                        }
                        
                    } catch (pendingError) {
                        console.error('Error updating pending transactions:', pendingError);
                        showToast('Success', 'User updated, but pending transactions could not be auto-approved.', 'warning');
                    }
                } else {
                    showToast('Success', 'User updated successfully!', 'success');
                }
                
                updateUsersTable();
                updateBalancesTable();
                updatePinsTable();
                updateTransactionsTable();
                
                closeEditModal();
                
                logAdminActivity(`User ${email} updated by admin`);
                
            } catch (error) {
                console.error('Error saving user edits:', error);
                showToast('Error', 'Failed to update user.', 'error');
            }
        }

        async function editBalance(userId) {
            try {
                const user = allUsers.find(u => u.id === userId);
                if (!user) {
                    showToast('Error', 'User not found.', 'error');
                    return;
                }
                
                const modalContent = document.getElementById('editBalanceContent');
                
                modalContent.innerHTML = `
                    <form id="editBalanceForm">
                        <div class="balance-group">
                            <div class="form-group">
                                <label class="form-label">Checking Balance</label>
                                <input type="number" class="form-input" id="editCheckingBalance" 
                                       value="${user.accounts?.checking?.balance || 0}" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Savings Balance</label>
                                <input type="number" class="form-input" id="editSavingsBalance" 
                                       value="${user.accounts?.savings?.balance || 0}" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Investment Balance</label>
                                <input type="number" class="form-input" id="editInvestmentBalance" 
                                       value="${user.accounts?.investment?.balance || 0}" step="0.01" min="0">
                            </div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeBalanceModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Balances</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('editBalanceModal').classList.add('active');
                
                document.getElementById('editBalanceForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveBalanceEdits(userId);
                });
                
            } catch (error) {
                console.error('Error loading balance editor:', error);
                showToast('Error', 'Failed to load balance data.', 'error');
            }
        }

        async function saveBalanceEdits(userId) {
            try {
                const checkingBalance = parseFloat(document.getElementById('editCheckingBalance').value) || 0;
                const savingsBalance = parseFloat(document.getElementById('editSavingsBalance').value) || 0;
                const investmentBalance = parseFloat(document.getElementById('editInvestmentBalance').value) || 0;
                
                await db.collection('users').doc(userId).update({
                    'accounts.checking.balance': checkingBalance,
                    'accounts.savings.balance': savingsBalance,
                    'accounts.investment.balance': investmentBalance,
                    'accounts.lastUpdated': new Date().toISOString()
                });
                
                const userIndex = allUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    if (!allUsers[userIndex].accounts) {
                        allUsers[userIndex].accounts = {};
                    }
                    allUsers[userIndex].accounts.checking = {
                        ...allUsers[userIndex].accounts.checking,
                        balance: checkingBalance
                    };
                    allUsers[userIndex].accounts.savings = {
                        ...allUsers[userIndex].accounts.savings,
                        balance: savingsBalance
                    };
                    allUsers[userIndex].accounts.investment = {
                        ...allUsers[userIndex].accounts.investment,
                        balance: investmentBalance
                    };
                    allUsers[userIndex].accounts.lastUpdated = new Date().toISOString();
                }
                
                updateBalancesTable();
                updateDashboardStats();
                
                closeBalanceModal();
                
                showToast('Success', 'Balances updated successfully!', 'success');
                
                logAdminActivity(`Balances updated for user: ${allUsers.find(u => u.id === userId)?.email}`);
                
            } catch (error) {
                console.error('Error saving balance edits:', error);
                showToast('Error', 'Failed to update balances.', 'error');
            }
        }

        async function editPin(userId) {
            try {
                const user = allUsers.find(u => u.id === userId);
                if (!user) {
                    showToast('Error', 'User not found.', 'error');
                    return;
                }
                
                const modalContent = document.getElementById('editPinContent');
                
                modalContent.innerHTML = `
                    <form id="editPinForm">
                        <div class="pin-group">
                            <label class="form-label">Set New 4-Digit PIN</label>
                            <p style="color: var(--text-light); font-size: 13px; margin-bottom: 12px;">
                                Current PIN: ${user.pin ? 'â€¢â€¢â€¢â€¢' : 'Not set'}
                            </p>
                            <div class="pin-input-container">
                                <input type="password" maxlength="1" class="pin-input" id="editPin1" required>
                                <input type="password" maxlength="1" class="pin-input" id="editPin2" required>
                                <input type="password" maxlength="1" class="pin-input" id="editPin3" required>
                                <input type="password" maxlength="1" class="pin-input" id="editPin4" required>
                            </div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closePinModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save PIN</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('editPinModal').classList.add('active');
                
                document.getElementById('editPin1').focus();
                
                document.getElementById('editPinForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await savePinEdits(userId);
                });
                
            } catch (error) {
                console.error('Error loading PIN editor:', error);
                showToast('Error', 'Failed to load PIN editor.', 'error');
            }
        }

        async function savePinEdits(userId) {
            try {
                const pin1 = document.getElementById('editPin1').value;
                const pin2 = document.getElementById('editPin2').value;
                const pin3 = document.getElementById('editPin3').value;
                const pin4 = document.getElementById('editPin4').value;
                
                const newPin = pin1 + pin2 + pin3 + pin4;
                
                if (newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                    showToast('Error', 'Please enter a valid 4-digit PIN.', 'error');
                    return;
                }
                
                await db.collection('users').doc(userId).update({
                    pin: newPin,
                    pinUpdatedAt: new Date().toISOString()
                });
                
                const userIndex = allUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex].pin = newPin;
                    allUsers[userIndex].pinUpdatedAt = new Date().toISOString();
                }
                
                updatePinsTable();
                updateUsersTable();
                
                closePinModal();
                
                showToast('Success', 'PIN updated successfully!', 'success');
                
                logAdminActivity(`PIN updated for user: ${allUsers.find(u => u.id === userId)?.email}`);
                
            } catch (error) {
                console.error('Error saving PIN edits:', error);
                showToast('Error', 'Failed to update PIN.', 'error');
            }
        }

        async function editTransaction(userId, transactionId) {
            try {
                const transaction = allTransactions.find(t => 
                    t.userId === userId && t.id === transactionId
                );
                
                if (!transaction) {
                    showToast('Error', 'Transaction not found.', 'error');
                    return;
                }
                
                currentEditTransactionId = { userId, transactionId };
                
                const modalContent = document.getElementById('editTransactionContent');
                const date = new Date(transaction.date);
                const formattedDate = date.toISOString().split('T')[0];
                const formattedTime = date.toTimeString().split(' ')[0].substring(0, 5);
                
                modalContent.innerHTML = `
                    <form id="editTransactionForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Transaction Type *</label>
                                <select class="form-select" id="editTransactionType" required>
                                    <option value="credit" ${transaction.type === 'credit' ? 'selected' : ''}>Credit</option>
                                    <option value="debit" ${transaction.type === 'debit' ? 'selected' : ''}>Debit</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount *</label>
                                <input type="number" class="form-input" id="editTransactionAmount" 
                                       value="${transaction.amount}" step="0.01" min="0" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Description *</label>
                                <input type="text" class="form-input" id="editTransactionDescription" 
                                       value="${transaction.description}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bank Name</label>
                                <input type="text" class="form-input" id="editTransactionBank" 
                                       value="${transaction.bank || ''}">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Recipient Name</label>
                                <input type="text" class="form-input" id="editTransactionRecipient" 
                                       value="${transaction.recipientName || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status *</label>
                                <select class="form-select" id="editTransactionStatus" required>
                                    <option value="completed" ${transaction.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="pending" ${transaction.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="failed" ${transaction.status === 'failed' ? 'selected' : ''}>Failed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Date *</label>
                                <input type="date" class="form-input" id="editTransactionDate" 
                                       value="${formattedDate}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time *</label>
                                <input type="time" class="form-input" id="editTransactionTime" 
                                       value="${formattedTime}" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="editTransactionCategory">
                                <option value="">Select Category</option>
                                <option value="shopping" ${transaction.category === 'shopping' ? 'selected' : ''}>Shopping</option>
                                <option value="food" ${transaction.category === 'food' ? 'selected' : ''}>Food & Dining</option>
                                <option value="salary" ${transaction.category === 'salary' ? 'selected' : ''}>Salary</option>
                                <option value="transfer" ${transaction.category === 'transfer' ? 'selected' : ''}>Transfer</option>
                                <option value="bill" ${transaction.category === 'bill' ? 'selected' : ''}>Bill Payment</option>
                                <option value="investment" ${transaction.category === 'investment' ? 'selected' : ''}>Investment</option>
                                <option value="entertainment" ${transaction.category === 'entertainment' ? 'selected' : ''}>Entertainment</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Additional Notes</label>
                            <textarea class="form-textarea" id="editTransactionNotes" 
                                      rows="3">${transaction.notes || ''}</textarea>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">Cancel</button>
                            <button type="button" class="btn btn-danger" onclick="deleteTransaction('${userId}', '${transactionId}')">Delete</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('editTransactionModal').classList.add('active');
                
                document.getElementById('editTransactionForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveTransactionEdits(userId, transactionId);
                });
                
            } catch (error) {
                console.error('Error loading transaction editor:', error);
                showToast('Error', 'Failed to load transaction data.', 'error');
            }
        }

        async function saveTransactionEdits(userId, transactionId) {
            try {
                const type = document.getElementById('editTransactionType').value;
                const amount = parseFloat(document.getElementById('editTransactionAmount').value);
                const description = document.getElementById('editTransactionDescription').value.trim();
                const bank = document.getElementById('editTransactionBank').value.trim();
                const recipientName = document.getElementById('editTransactionRecipient').value.trim();
                const status = document.getElementById('editTransactionStatus').value;
                const date = document.getElementById('editTransactionDate').value;
                const time = document.getElementById('editTransactionTime').value;
                const category = document.getElementById('editTransactionCategory').value;
                const notes = document.getElementById('editTransactionNotes').value.trim();
                
                if (!type || !amount || !description || !status || !date || !time) {
                    showToast('Error', 'Please fill in all required fields.', 'error');
                    return;
                }
                
                const transactionDate = new Date(`${date}T${time}`);
                
                await db.collection('users').doc(userId)
                    .collection('transactions').doc(transactionId)
                    .update({
                        type,
                        amount,
                        description,
                        bank,
                        recipientName,
                        status,
                        date: transactionDate.toISOString(),
                        category,
                        notes,
                        updatedAt: new Date().toISOString()
                    });
                
                const transactionIndex = allTransactions.findIndex(t => 
                    t.userId === userId && t.id === transactionId
                );
                
                if (transactionIndex !== -1) {
                    allTransactions[transactionIndex] = {
                        ...allTransactions[transactionIndex],
                        type,
                        amount,
                        description,
                        bank,
                        recipientName,
                        status,
                        date: transactionDate.toISOString(),
                        category,
                        notes
                    };
                }
                
                updateTransactionsTable();
                updateDashboardStats();
                updateActivityLog();
                
                closeTransactionModal();
                
                showToast('Success', 'Transaction updated successfully!', 'success');
                
                logAdminActivity(`Transaction ${transactionId} updated`);
                
            } catch (error) {
                console.error('Error saving transaction edits:', error);
                showToast('Error', 'Failed to update transaction.', 'error');
            }
        }

        // ==============================
        // CREATE USER FUNCTIONS
        // ==============================
        async function createNewUser(userData) {
            try {
                showToast('Creating', 'Creating new user account...', 'info');
                
                const userCredential = await auth.createUserWithEmailAndPassword(
                    userData.email, 
                    userData.password
                );
                
                const firestoreUserData = {
                    firstName: userData.firstName,
                    lastName: userData.lastName,
                    email: userData.email.toLowerCase(),
                    phone: userData.phone,
                    accountNumber: userData.accountNumber,
                    transactionApproval: userData.transactionApproval,
                    role: userData.role,
                    status: userData.status,
                    pin: userData.pin,
                    profilePicture: userData.profilePicture || null,
                    createdAt: new Date().toISOString(),
                    lastLogin: null,
                    accounts: {
                        checking: {
                            balance: userData.checkingBalance,
                            accountNumber: userData.accountNumber,
                            fullNumber: userData.accountNumber,
                            type: 'checking',
                            currency: 'USD'
                        },
                        savings: {
                            balance: userData.savingsBalance,
                            accountNumber: `â€¢â€¢â€¢â€¢ ${userData.accountNumber.substring(userData.accountNumber.length - 4)}`,
                            fullNumber: userData.accountNumber.replace(/\d{4}(?= \d{4})/g, '****'),
                            type: 'savings',
                            currency: 'USD'
                        },
                        investment: {
                            balance: userData.investmentBalance,
                            accountNumber: `â€¢â€¢â€¢â€¢ ${userData.accountNumber.substring(userData.accountNumber.length - 4)}`,
                            type: 'investment',
                            portfolioType: 'IRA â€¢ Roth Account',
                            currency: 'USD',
                            ytdReturn: 5.2
                        },
                        lastUpdated: new Date().toISOString()
                    }
                };
                
                await db.collection('users').doc(userCredential.user.uid).set(firestoreUserData);
                
                allUsers.push({
                    id: userCredential.user.uid,
                    ...firestoreUserData
                });
                
                updateUsersTable();
                updateBalancesTable();
                updatePinsTable();
                updateDashboardStats();
                
                resetCreateUserForm();
                
                showToast('Success', 'User created successfully!', 'success');
                
                logAdminActivity(`New user created: ${userData.email}`);
                
                showSection('users');
                
            } catch (error) {
                console.error('Error creating user:', error);
                
                let errorMessage = 'Failed to create user. Please try again.';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'This email is already registered.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak. Use at least 8 characters.';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showToast('Error', errorMessage, 'error');
            }
        }

        function resetCreateUserForm() {
            document.getElementById('createUserForm').reset();
            document.getElementById('createProfilePictureUrl').value = '';
            document.getElementById('createProfileImage').src = '';
            document.getElementById('createProfileImage').style.display = 'none';
            document.getElementById('createProfileInitials').style.display = 'block';
            document.getElementById('createProfileInitials').textContent = 'JD';
            
            document.querySelectorAll('#createPin1, #createPin2, #createPin3, #createPin4').forEach(input => {
                input.value = '';
            });
            
            const randomAccount = '4500 ' + 
                Math.floor(1000 + Math.random() * 9000) + ' ' + 
                Math.floor(1000 + Math.random() * 9000) + ' ' + 
                Math.floor(1000 + Math.random() * 9000);
            document.getElementById('createAccountNumber').value = randomAccount;
            
            document.getElementById('createTransactionApproval').checked = true;
            document.getElementById('createTransactionStatusLabel').innerHTML = '<i class="fas fa-check-circle"></i> Approved';
            document.getElementById('createTransactionStatusLabel').className = 'transaction-status-label approved';
            
            document.getElementById('createCheckingBalance').value = 1000;
            document.getElementById('createSavingsBalance').value = 5000;
            document.getElementById('createInvestmentBalance').value = 25000;
        }

        // ==============================
        // DELETE FUNCTIONS
        // ==============================
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            try {
                const userEmail = allUsers.find(u => u.id === userId)?.email;
                
                await db.collection('users').doc(userId).update({
                    status: 'deleted',
                    deletedAt: new Date().toISOString()
                });
                
                allUsers = allUsers.filter(user => user.id !== userId);
                allTransactions = allTransactions.filter(t => t.userId !== userId);
                
                updateUsersTable();
                updateBalancesTable();
                updatePinsTable();
                updateDashboardStats();
                updateTransactionsTable();
                populateUserFilter();
                
                closeEditModal();
                
                showToast('Success', 'User deleted successfully!', 'success');
                
                logAdminActivity(`User deleted: ${userEmail}`);
                
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Error', 'Failed to delete user.', 'error');
            }
        }

        async function deleteTransaction(userId, transactionId) {
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }
            
            try {
                await db.collection('users').doc(userId)
                    .collection('transactions').doc(transactionId)
                    .delete();
                
                allTransactions = allTransactions.filter(t => 
                    !(t.userId === userId && t.id === transactionId)
                );
                
                updateTransactionsTable();
                updateDashboardStats();
                updateActivityLog();
                
                closeTransactionModal();
                
                showToast('Success', 'Transaction deleted successfully!', 'success');
                
                logAdminActivity(`Transaction ${transactionId} deleted`);
                
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showToast('Error', 'Failed to delete transaction.', 'error');
            }
        }

        async function resetBalances(userId) {
            if (!confirm('Reset all balances to default values?')) {
                return;
            }
            
            try {
                const defaultBalances = {
                    checking: 1000.00,
                    savings: 5000.00,
                    investment: 25000.00
                };
                
                await db.collection('users').doc(userId).update({
                    'accounts.checking.balance': defaultBalances.checking,
                    'accounts.savings.balance': defaultBalances.savings,
                    'accounts.investment.balance': defaultBalances.investment,
                    'accounts.lastUpdated': new Date().toISOString()
                });
                
                const userIndex = allUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex].accounts.checking.balance = defaultBalances.checking;
                    allUsers[userIndex].accounts.savings.balance = defaultBalances.savings;
                    allUsers[userIndex].accounts.investment.balance = defaultBalances.investment;
                    allUsers[userIndex].accounts.lastUpdated = new Date().toISOString();
                }
                
                updateBalancesTable();
                updateDashboardStats();
                
                showToast('Success', 'Balances reset to default!', 'success');
                
                logAdminActivity(`Balances reset for user: ${allUsers.find(u => u.id === userId)?.email}`);
                
            } catch (error) {
                console.error('Error resetting balances:', error);
                showToast('Error', 'Failed to reset balances.', 'error');
            }
        }

        async function resetPin(userId) {
            if (!confirm('Reset user PIN? User will need to set a new PIN on next login.')) {
                return;
            }
            
            try {
                await db.collection('users').doc(userId).update({
                    pin: null,
                    pinUpdatedAt: null
                });
                
                const userIndex = allUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex].pin = null;
                    allUsers[userIndex].pinUpdatedAt = null;
                }
                
                updatePinsTable();
                updateUsersTable();
                
                showToast('Success', 'PIN reset successfully!', 'success');
                
                logAdminActivity(`PIN reset for user: ${allUsers.find(u => u.id === userId)?.email}`);
                
            } catch (error) {
                console.error('Error resetting PIN:', error);
                showToast('Error', 'Failed to reset PIN.', 'error');
            }
        }

        // ==============================
        // HELPER FUNCTIONS
        // ==============================
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(section + 'Section').classList.add('active');
            
            document.querySelector(`.nav-tab[data-section="${section}"]`).classList.add('active');
            
            window.scrollTo(0, 0);
        }

        function closeEditModal() {
            document.getElementById('editUserModal').classList.remove('active');
            currentEditUserId = null;
        }

        function closeTransactionModal() {
            document.getElementById('editTransactionModal').classList.remove('active');
            currentEditTransactionId = null;
        }

        function closeBalanceModal() {
            document.getElementById('editBalanceModal').classList.remove('active');
        }

        function closePinModal() {
            document.getElementById('editPinModal').classList.remove('active');
        }

        function closePasswordModal() {
            document.getElementById('resetPasswordModal').classList.remove('active');
            currentPasswordResetUserId = null;
        }

        function closeAddTransactionModal() {
            document.getElementById('addTransactionModalOverlay').classList.remove('active');
        }

        function initPinInputs() {
            const createPinInputs = ['createPin1', 'createPin2', 'createPin3', 'createPin4'];
            createPinInputs.forEach((id, index) => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function() {
                        if (this.value.length === 1 && index < createPinInputs.length - 1) {
                            document.getElementById(createPinInputs[index + 1]).focus();
                        }
                    });
                    
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                            document.getElementById(createPinInputs[index - 1]).focus();
                        }
                    });
                }
            });
            
            const editPinInputs = ['editPin1', 'editPin2', 'editPin3', 'editPin4'];
            editPinInputs.forEach((id, index) => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function() {
                        if (this.value.length === 1 && index < editPinInputs.length - 1) {
                            document.getElementById(editPinInputs[index + 1]).focus();
                        }
                    });
                    
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                            document.getElementById(editPinInputs[index - 1]).focus();
                        }
                    });
                }
            });
        }

        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('toastNotification');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast`;
            toastIcon.className = `toast-icon toast-${type}`;
            
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            
            toastIcon.innerHTML = `<i class="fas ${icons[type]}"></i>`;
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // ==============================
        // ADD TRANSACTION FUNCTIONS
        // ==============================
        function showAddTransactionModal() {
            const modalContent = document.getElementById('addTransactionContent');
            
            const userOptions = allUsers.map(user => 
                `<option value="${user.id}">${user.firstName} ${user.lastName} (${user.email})</option>`
            ).join('');
            
            modalContent.innerHTML = `
                <form id="addTransactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Select User *</label>
                            <select class="form-select" id="addTransactionUser" required>
                                <option value="">Select a user</option>
                                ${userOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Transaction Type *</label>
                            <select class="form-select" id="addTransactionType" required>
                                <option value="credit">Credit</option>
                                <option value="debit">Debit</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Amount *</label>
                            <input type="number" class="form-input" id="addTransactionAmount" 
                                   step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="addTransactionCategory">
                                <option value="">Select Category</option>
                                <option value="shopping">Shopping</option>
                                <option value="food">Food & Dining</option>
                                <option value="salary">Salary</option>
                                <option value="transfer">Transfer</option>
                                <option value="bill">Bill Payment</option>
                                <option value="investment">Investment</option>
                                <option value="entertainment">Entertainment</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <input type="text" class="form-input" id="addTransactionDescription" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-input" id="addTransactionBank">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Recipient Name</label>
                            <input type="text" class="form-input" id="addTransactionRecipient">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-select" id="addTransactionStatus" required>
                                <option value="completed">Completed</option>
                                <option value="pending">Pending</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-input" id="addTransactionDate" 
                                   value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-textarea" id="addTransactionNotes" rows="3"></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAddTransactionModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Transaction</button>
                    </div>
                </form>
            `;
            
            document.getElementById('addTransactionModalOverlay').classList.add('active');
            
            document.getElementById('addTransactionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addNewTransaction();
            });
        }

        async function addNewTransaction() {
            try {
                const userId = document.getElementById('addTransactionUser').value;
                const type = document.getElementById('addTransactionType').value;
                const amount = parseFloat(document.getElementById('addTransactionAmount').value);
                const description = document.getElementById('addTransactionDescription').value.trim();
                const bank = document.getElementById('addTransactionBank').value.trim();
                const recipientName = document.getElementById('addTransactionRecipient').value.trim();
                const status = document.getElementById('addTransactionStatus').value;
                const date = document.getElementById('addTransactionDate').value;
                const category = document.getElementById('addTransactionCategory').value;
                const notes = document.getElementById('addTransactionNotes').value.trim();
                
                if (!userId || !type || !amount || !description || !status || !date) {
                    showToast('Error', 'Please fill in all required fields.', 'error');
                    return;
                }
                
                const transactionDate = new Date(date);
                transactionDate.setHours(12, 0, 0, 0);
                
                const user = allUsers.find(u => u.id === userId);
                if (!user) {
                    showToast('Error', 'User not found.', 'error');
                    return;
                }
                
                // Check if user has transaction approval enabled
                const userTransactionApproval = user.transactionApproval !== false;
                
                // Determine final status based on user's approval setting
                let finalStatus = status;
                if (userTransactionApproval) {
                    // User has approval enabled - auto-approve if pending
                    if (status === 'pending') {
                        finalStatus = 'completed';
                        showToast('Info', 'Transaction auto-approved (user has approval enabled)', 'info');
                    }
                } else {
                    // User has approval disabled - force all transactions to pending
                    finalStatus = 'pending';
                    showToast('Info', 'Transaction set to pending (user has approval disabled)', 'info');
                }
                
                const transactionRef = await db.collection('users').doc(userId)
                    .collection('transactions').add({
                        type,
                        amount,
                        description,
                        bank,
                        recipientName,
                        status: finalStatus,
                        date: transactionDate.toISOString(),
                        category,
                        notes,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                
                allTransactions.push({
                    id: transactionRef.id,
                    userId: userId,
                    userName: `${user.firstName} ${user.lastName}`,
                    userEmail: user.email,
                    type,
                    amount,
                    description,
                    bank,
                    recipientName,
                    status: finalStatus,
                    date: transactionDate.toISOString(),
                    category,
                    notes
                });
                
                updateTransactionsTable();
                updateDashboardStats();
                updateActivityLog();
                
                closeAddTransactionModal();
                
                showToast('Success', 'Transaction added successfully!', 'success');
                
                logAdminActivity(`New transaction added for ${user.email}: $${amount} ${type} (${finalStatus})`);
                
            } catch (error) {
                console.error('Error adding transaction:', error);
                showToast('Error', 'Failed to add transaction.', 'error');
            }
        }

        function filterUsersTable(searchTerm) {
            const rows = document.querySelectorAll('#usersTableBody tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function filterPinsTable(searchTerm) {
            const rows = document.querySelectorAll('#pinsTableBody tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function updateCreateProfileInitials() {
            const firstName = document.getElementById('createFirstName').value || 'J';
            const lastName = document.getElementById('createLastName').value || 'D';
            const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
            document.getElementById('createProfileInitials').textContent = initials;
        }

        // ==============================
        // EVENT LISTENERS
        // ==============================
        function initEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    const errorMessage = document.getElementById('errorMessage');
                    errorMessage.textContent = 'Please enter both email and password.';
                    document.getElementById('loginError').classList.add('show');
                    return;
                }
                
                await handleLogin(email, password);
            });
            
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const section = this.dataset.section;
                    showSection(section);
                });
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Close modal buttons
            document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
            document.getElementById('closeTransactionModal').addEventListener('click', closeTransactionModal);
            document.getElementById('closeBalanceModal').addEventListener('click', closeBalanceModal);
            document.getElementById('closePinModal').addEventListener('click', closePinModal);
            document.getElementById('closePasswordModal').addEventListener('click', closePasswordModal);
            document.getElementById('closeAddTransactionModal').addEventListener('click', closeAddTransactionModal);
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // Search functionality
            document.getElementById('userSearch').addEventListener('input', function() {
                filterUsersTable(this.value);
            });
            
            document.getElementById('pinSearch').addEventListener('input', function() {
                filterPinsTable(this.value);
            });
            
            // Transaction filters
            document.getElementById('transactionUserFilter').addEventListener('change', updateTransactionsTable);
            document.getElementById('transactionTypeFilter').addEventListener('change', updateTransactionsTable);
            document.getElementById('dateFromFilter').addEventListener('change', updateTransactionsTable);
            document.getElementById('dateToFilter').addEventListener('change', updateTransactionsTable);
            
            // Add transaction button
            document.getElementById('addTransactionBtn').addEventListener('click', () => {
                showAddTransactionModal();
            });
            
            // Update all balances button
            document.getElementById('updateAllBalancesBtn').addEventListener('click', () => {
                showToast('Info', 'This would update all user balances in batch.', 'info');
            });
            
            // Create user form
            document.getElementById('createUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const firstName = document.getElementById('createFirstName').value.trim();
                const lastName = document.getElementById('createLastName').value.trim();
                const email = document.getElementById('createEmail').value.trim();
                const phone = document.getElementById('createPhone').value.trim();
                const accountNumber = document.getElementById('createAccountNumber').value.trim();
                const transactionApproval = document.getElementById('createTransactionApproval').checked;
                const password = document.getElementById('createPassword').value;
                const confirmPassword = document.getElementById('createConfirmPassword').value;
                const role = document.getElementById('createRole').value;
                const status = document.getElementById('createStatus').value;
                const profilePicture = document.getElementById('createProfilePictureUrl').value;
                
                const pin1 = document.getElementById('createPin1').value;
                const pin2 = document.getElementById('createPin2').value;
                const pin3 = document.getElementById('createPin3').value;
                const pin4 = document.getElementById('createPin4').value;
                const pin = pin1 + pin2 + pin3 + pin4;
                
                const checkingBalance = parseFloat(document.getElementById('createCheckingBalance').value) || 0;
                const savingsBalance = parseFloat(document.getElementById('createSavingsBalance').value) || 0;
                const investmentBalance = parseFloat(document.getElementById('createInvestmentBalance').value) || 0;
                
                if (!firstName || !lastName || !email || !phone || !accountNumber || !password || !confirmPassword) {
                    showToast('Error', 'Please fill in all required fields.', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showToast('Error', 'Passwords do not match.', 'error');
                    return;
                }
                
                if (password.length < 8) {
                    showToast('Error', 'Password must be at least 8 characters long.', 'error');
                    return;
                }
                
                if (accountNumber.replace(/\s/g, '').length < 12) {
                    showToast('Error', 'Please enter a valid account number (at least 12 digits).', 'error');
                    return;
                }
                
                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    showToast('Error', 'Please enter a valid 4-digit PIN.', 'error');
                    return;
                }
                
                const userData = {
                    firstName,
                    lastName,
                    email,
                    phone,
                    accountNumber,
                    transactionApproval,
                    password,
                    role,
                    status,
                    pin,
                    profilePicture,
                    checkingBalance,
                    savingsBalance,
                    investmentBalance
                };
                
                await createNewUser(userData);
            });
            
            // Create user - upload picture button
            document.getElementById('createUploadPictureBtn').addEventListener('click', () => {
                openCloudinaryWidget('create');
            });
            
            // Create user - transaction approval toggle
            document.getElementById('createTransactionApproval').addEventListener('change', function() {
                const label = document.getElementById('createTransactionStatusLabel');
                if (this.checked) {
                    label.innerHTML = '<i class="fas fa-check-circle"></i> Approved';
                    label.className = 'transaction-status-label approved';
                } else {
                    label.innerHTML = '<i class="fas fa-clock"></i> Pending';
                    label.className = 'transaction-status-label pending';
                }
            });
            
            // Create user - reset form button
            document.getElementById('resetFormBtn').addEventListener('click', resetCreateUserForm);
            
            // Create user - cancel button
            document.getElementById('cancelCreateBtn').addEventListener('click', () => {
                resetCreateUserForm();
                showSection('users');
            });
            
            // Update profile initials when name changes
            document.getElementById('createFirstName').addEventListener('input', updateCreateProfileInitials);
            document.getElementById('createLastName').addEventListener('input', updateCreateProfileInitials);
            
            // Toast close button
            document.getElementById('toastClose').addEventListener('click', () => {
                document.getElementById('toastNotification').classList.remove('show');
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeEditModal();
                    closeTransactionModal();
                    closeBalanceModal();
                    closePinModal();
                    closePasswordModal();
                    closeAddTransactionModal();
                }
            });
        }
    </script>
</body>
</html>
